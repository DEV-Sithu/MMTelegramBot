require('dotenv').config();
const { Telegraf } = require('telegraf');

const bot = new Telegraf(process.env.BOT_TOKEN);

// á€™á€¼á€”á€ºá€™á€¬á€•á€Šá€¬á€›á€±á€¸áŠ á€€á€»á€”á€ºá€¸á€™á€¬á€›á€±á€¸áŠ á€…á€®á€¸á€•á€½á€¬á€¸á€›á€±á€¸á€”á€¾á€„á€·á€º á€¡á€¬á€¸á€€á€…á€¬á€¸á€†á€­á€¯á€„á€ºá€›á€¬ á€™á€±á€¸á€á€½á€”á€ºá€¸ áá€á€
const quizQuestions = [
  // á€•á€Šá€¬á€›á€±á€¸ (25)
  {
    question: "á€™á€¼á€”á€ºá€™á€¬á€”á€­á€¯á€„á€ºá€„á€¶á á€•á€‘á€™á€†á€¯á€¶á€¸ á€á€€á€¹á€€á€žá€­á€¯á€œá€ºá€™á€¾á€¬ á€™á€Šá€ºá€žá€Šá€ºá€”á€Šá€ºá€¸á‹",
    options: ["á€›á€”á€ºá€€á€¯á€”á€ºá€á€€á€¹á€€á€žá€­á€¯á€œá€º", "á€™á€”á€¹á€á€œá€±á€¸á€á€€á€¹á€€á€žá€­á€¯á€œá€º", "á€•á€¯á€žá€­á€™á€ºá€á€€á€¹á€€á€žá€­á€¯á€œá€º", "á€™á€±á€¬á€ºá€œá€™á€¼á€­á€¯á€„á€ºá€á€€á€¹á€€á€žá€­á€¯á€œá€º"],
    correct: 0
  },
  {
    question: "á€¡á€±á€¬á€€á€ºá€•á€«á€˜á€¬á€žá€¬á€›á€•á€ºá€™á€»á€¬á€¸á€¡á€”á€€á€º á€™á€¼á€”á€ºá€™á€¬á€·á€›á€­á€¯á€¸á€›á€¬ á€¡á€á€á€ºá€•á€Šá€¬á€™á€Ÿá€¯á€á€ºá€žá€±á€¬á€˜á€¬á€žá€¬á€›á€•á€ºá€™á€¾á€¬ á€™á€Šá€ºá€žá€Šá€ºá€”á€Šá€ºá€¸á‹",
    options: ["á€•á€”á€ºá€¸á€á€»á€®", "á€•á€”á€ºá€¸á€•á€¯", "á€¡á€„á€ºá€‚á€»á€„á€ºá€”á€®á€šá€¬", "á€€á€á€¼á€±á€žá€Šá€ºá€¡á€á€á€º"],
    correct: 2
  },
  {
    question: "á€™á€¼á€”á€ºá€™á€¬á€”á€­á€¯á€„á€ºá€„á€¶á á€•á€Šá€¬á€›á€±á€¸á€á€”á€ºá€€á€¼á€®á€¸á€Œá€¬á€” á€œá€­á€¯á€‚á€­á€¯á€á€½á€„á€º á€•á€«á€á€„á€ºá€žá€±á€¬á€¡á€›á€¬á€™á€¾á€¬ á€™á€Šá€ºá€žá€Šá€ºá€”á€Šá€ºá€¸á‹",
    options: ["á€…á€¬á€¡á€¯á€•á€º", "á€•á€±á€á€»á€•á€º", "á€€á€œá€±á€¬á€€á€ºá€˜á€¯á€á€º", "á€˜á€±á€¬á€•á€„á€ºá€”á€¾á€„á€·á€ºá€™á€¾á€”á€º"],
    correct: 3
  },
  {
    question: "á€•á€‘á€™á€†á€¯á€¶á€¸ á€™á€¼á€”á€ºá€™á€¬á€…á€¬á€•á€±á€€á€»á€±á€¬á€ºá€…á€½á€¬ á€˜á€½á€²á€·á€›á€žá€°á€™á€¾á€¬ á€™á€Šá€ºá€žá€°á€”á€Šá€ºá€¸á‹",
    options: ["á€†á€›á€¬á€€á€¼á€®á€¸á€¦á€¸á€§á€™á€±á€¬á€„á€º", "á€†á€›á€¬á€€á€¼á€®á€¸á€¦á€¸á€–á€­á€¯á€¸á€€á€»á€¬á€¸", "á€†á€›á€¬á€€á€¼á€®á€¸á€¦á€¸á€˜á€œá€½á€„á€º", "á€†á€›á€¬á€€á€¼á€®á€¸á€¦á€¸á€žá€±á€¬á€ºá€‡á€„á€º"],
    correct: 0
  },
  {
    question: "á€¡á€±á€¬á€€á€ºá€•á€«á€€á€»á€±á€¬á€„á€ºá€¸á€™á€»á€¬á€¸á€¡á€”á€€á€º á€™á€¼á€”á€ºá€™á€¬á€”á€­á€¯á€„á€ºá€„á€¶á á€¡á€žá€€á€ºá€¡á€€á€¼á€®á€¸á€†á€¯á€¶á€¸ á€¡á€‘á€€á€ºá€á€”á€ºá€¸á€€á€»á€±á€¬á€„á€ºá€¸á€™á€¾á€¬ á€™á€Šá€ºá€žá€Šá€ºá€”á€Šá€ºá€¸á‹",
    options: ["á€—á€Ÿá€­á€¯á€¡á€™á€»á€­á€¯á€¸á€žá€¬á€¸á€¡á€‘á€€á€ºá€á€”á€ºá€¸á€€á€»á€±á€¬á€„á€ºá€¸", "á€™á€¼á€”á€ºá€™á€¬á€šá€°á€”á€®á€—á€¬á€…á€®á€á€®", "á€†á€­á€á€ºá€–á€¼á€°á€€á€¯á€”á€ºá€¸á€¡á€‘á€€", "á€—á€Ÿá€­á€¯á€¡á€™á€»á€­á€¯á€¸á€žá€™á€®á€¸á€¡á€‘á€€"],
    correct: 0
  },
  // á€€á€»á€”á€ºá€¸á€™á€¬á€›á€±á€¸ (25)
  {
    question: "á€¡á€±á€¬á€€á€ºá€•á€«á€á€­á€¯á€·á€¡á€”á€€á€º á€™á€¼á€”á€ºá€™á€¬á€·á€†á€±á€¸á€•á€Šá€¬á€á€½á€„á€º á€¡á€žá€¯á€¶á€¸á€•á€¼á€¯á€žá€±á€¬ á€žá€˜á€¬á€á€†á€±á€¸á€–á€€á€ºá€á€„á€ºá€¡á€•á€„á€ºá€™á€¾á€¬ á€™á€Šá€ºá€žá€Šá€ºá€”á€Šá€ºá€¸á‹",
    options: ["á€”á€”á€½á€„á€ºá€¸", "á€•á€„á€ºá€…á€­á€™á€ºá€¸", "á€€á€¼á€€á€ºá€žá€½á€”á€ºá€–á€¼á€°", "á€¡á€¬á€¸á€œá€¯á€¶á€¸"],
    correct: 3
  },
  {
    question: "á€€á€™á€¹á€˜á€¬á€·á€€á€»á€”á€ºá€¸á€™á€¬á€›á€±á€¸á€¡á€–á€½á€²á€·á á€¡á€á€­á€¯á€€á€±á€¬á€€á€ºá€¡á€™á€Šá€ºá€™á€¾á€¬ á€™á€Šá€ºá€žá€Šá€ºá€”á€Šá€ºá€¸á‹",
    options: ["WHO", "UNICEF", "UNESCO", "FAO"],
    correct: 0
  },
  {
    question: "á€™á€¼á€”á€ºá€™á€¬á€”á€­á€¯á€„á€ºá€„á€¶á€á€½á€„á€º á€•á€‘á€™á€†á€¯á€¶á€¸ á€á€½á€²á€…á€­á€á€ºá€€á€¯á€žá€™á€¾á€¯á€•á€¼á€¯á€œá€¯á€•á€ºá€á€²á€·á€žá€±á€¬ á€†á€±á€¸á€›á€¯á€¶á€™á€¾á€¬ á€™á€Šá€ºá€žá€Šá€ºá€”á€Šá€ºá€¸á‹",
    options: ["á€›á€”á€ºá€€á€¯á€”á€ºá€¡á€‘á€½á€±á€‘á€½á€±á€›á€¯á€¶á€¸", "á€™á€”á€¹á€á€œá€±á€¸á€¡á€‘á€½á€±á€‘á€½á€±á€›á€¯á€¶á€¸", "á€†á€±á€¸á€á€€á€¹á€€á€žá€­á€¯á€œá€º (á) á€›á€¯á€¶á€¸", "á€•á€¼á€Šá€ºá€žá€°á€·á€†á€±á€¸á€›á€¯á€¶"],
    correct: 0
  },
  {
    question: "á€¡á€±á€¬á€€á€ºá€•á€«á€¡á€…á€¬á€¸á€¡á€…á€¬á€™á€»á€¬á€¸á€¡á€”á€€á€º á€—á€®á€á€¬á€™á€„á€º C á€¡á€™á€»á€¬á€¸á€†á€¯á€¶á€¸á€•á€«á€á€„á€ºá€žá€±á€¬ á€¡á€žá€®á€¸á€™á€¾á€¬ á€™á€Šá€ºá€žá€Šá€ºá€”á€Šá€ºá€¸á‹",
    options: ["á€žá€¶á€•á€¯á€›á€¬á€žá€®á€¸", "á€€á€™á€¹á€˜á€¬á€·á€žá€›á€€á€ºá€žá€®á€¸", "á€…á€á€±á€¬á€ºá€˜á€šá€ºá€›á€®", "á€¡á€™á€²á€žá€¬á€¸"],
    correct: 0
  },
  {
    question: "á€žá€½á€±á€¸á€á€­á€¯á€¸á€›á€±á€¬á€‚á€«á€€á€­á€¯ á€‘á€­á€”á€ºá€¸á€á€»á€¯á€•á€ºá€›á€”á€ºá€¡á€á€½á€€á€º á€¡á€€á€±á€¬á€„á€ºá€¸á€†á€¯á€¶á€¸á€”á€Šá€ºá€¸á€œá€™á€ºá€¸á€™á€¾á€¬ á€™á€Šá€ºá€žá€Šá€ºá€”á€Šá€ºá€¸á‹",
    options: ["á€¡á€„á€”á€ºá€œá€»á€¾á€±á€¬á€·á€…á€¬á€¸á€á€¼á€„á€ºá€¸", "á€¡á€¬á€¸á€€á€…á€¬á€¸á€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸", "á€…á€­á€á€ºá€–á€­á€…á€®á€¸á€™á€¾á€¯á€œá€»á€¾á€±á€¬á€·á€á€»á€á€¼á€„á€ºá€¸", "á€¡á€¬á€¸á€œá€¯á€¶á€¸"],
    correct: 3
  },
  // á€…á€®á€¸á€•á€½á€¬á€¸á€›á€±á€¸ (25)
  {
    question: "á€™á€¼á€”á€ºá€™á€¬á€”á€­á€¯á€„á€ºá€„á€¶á á€¡á€“á€­á€€á€á€„á€ºá€•á€­á€¯á€·á€€á€¯á€”á€ºá€™á€¾á€¬ á€™á€Šá€ºá€žá€Šá€ºá€”á€Šá€ºá€¸á‹",
    options: ["á€†á€”á€º", "á€žá€…á€º", "á€“á€¬á€á€ºá€„á€½á€±á€·", "á€•á€²á€™á€»á€­á€¯á€¸á€…á€¯á€¶"],
    correct: 2
  },
  {
    question: "á€™á€¼á€”á€ºá€™á€¬á€”á€­á€¯á€„á€ºá€„á€¶á€á€½á€„á€º á€•á€‘á€™á€†á€¯á€¶á€¸á€žá€±á€¬ á€…á€á€±á€¬á€·á€¡á€­á€á€ºá€á€»á€­á€”á€ºá€¸á€€á€­á€¯ á€™á€Šá€ºá€žá€Šá€·á€ºá€”á€¾á€…á€ºá€á€½á€„á€º á€…á€á€„á€ºá€–á€½á€„á€·á€ºá€œá€¾á€…á€ºá€á€²á€·á€žá€”á€Šá€ºá€¸á‹",
    options: ["1996", "2000", "2015", "2020"],
    correct: 0
  },
  {
    question: "á€¡á€±á€¬á€€á€ºá€•á€«á€˜á€á€ºá€™á€»á€¬á€¸á€¡á€”á€€á€º á€™á€¼á€”á€ºá€™á€¬á€”á€­á€¯á€„á€ºá€„á€¶á á€•á€‘á€™á€†á€¯á€¶á€¸ á€”á€­á€¯á€„á€ºá€„á€¶á€•á€­á€¯á€„á€ºá€˜á€á€ºá€™á€¾á€¬ á€™á€Šá€ºá€žá€Šá€ºá€”á€Šá€ºá€¸á‹",
    options: ["KBZ á€˜á€á€º", "á€›á€”á€ºá€€á€¯á€”á€ºá€˜á€á€º", "á€‚á€»á€®á€¡á€­á€¯á€„á€ºá€…á€®á€˜á€á€º", "CB á€˜á€á€º"],
    correct: 1
  },
  {
    question: "á€™á€¼á€”á€ºá€™á€¬á€”á€­á€¯á€„á€ºá€„á€¶á á€¡á€€á€¼á€®á€¸á€†á€¯á€¶á€¸ á€…á€€á€ºá€™á€¾á€¯á€‡á€¯á€”á€ºá€™á€¾á€¬ á€™á€Šá€ºá€žá€Šá€·á€ºá€”á€±á€›á€¬á€á€½á€„á€ºá€á€Šá€ºá€›á€¾á€­á€žá€”á€Šá€ºá€¸á‹",
    options: ["á€žá€”á€ºá€œá€»á€„á€º", "á€žá€®á€œá€á€«", "á€•á€¼á€Šá€ºá€€á€¼á€®á€¸á€á€¶á€á€½á€”á€º", "á€•á€¯á€žá€­á€™á€º"],
    correct: 0
  },
  {
    question: "á€™á€¼á€”á€ºá€™á€¬á€”á€­á€¯á€„á€ºá€„á€¶á€á€½á€„á€º á€”á€¾á€…á€ºá€…á€‰á€ºá€€á€»á€„á€ºá€¸á€•á€žá€±á€¬ á€”á€­á€¯á€„á€ºá€„á€¶á€á€€á€¬á€€á€¯á€”á€ºá€…á€Šá€ºá€•á€¼á€•á€½á€²á€€á€­á€¯ á€™á€Šá€ºá€žá€Šá€·á€ºá€™á€¼á€­á€¯á€·á€á€½á€„á€ºá€€á€»á€„á€ºá€¸á€•á€žá€”á€Šá€ºá€¸á‹",
    options: ["á€›á€”á€ºá€€á€¯á€”á€º", "á€™á€”á€¹á€á€œá€±á€¸", "á€”á€±á€•á€¼á€Šá€ºá€á€±á€¬á€º", "á€•á€²á€á€°á€¸"],
    correct: 0
  },
  // á€¡á€¬á€¸á€€á€…á€¬á€¸ (25)
  {
    question: "á€™á€¼á€”á€ºá€™á€¬á€·á€›á€­á€¯á€¸á€›á€¬ á€¡á€¬á€¸á€€á€…á€¬á€¸á€”á€Šá€ºá€¸á€™á€¾á€¬ á€™á€Šá€ºá€žá€Šá€ºá€”á€Šá€ºá€¸á‹",
    options: ["á€˜á€±á€¬á€œá€¯á€¶á€¸", "á€€á€¼á€€á€ºá€á€±á€¬á€€á€ºá€€á€½á€€á€º", "á€€á€¼á€€á€ºá€œá€»á€¾á€¬á€€á€½á€€á€º", "á€•á€­á€¯á€€á€ºá€€á€»á€±á€¬á€ºá€á€¼á€„á€ºá€¸"],
    correct: 1
  },
  {
    question: "á€¡á€±á€¬á€€á€ºá€•á€«á€¡á€¬á€¸á€€á€…á€¬á€¸á€žá€™á€¬á€¸á€™á€»á€¬á€¸á€¡á€”á€€á€º á€”á€­á€¯á€„á€ºá€„á€¶á€á€€á€¬á€†á€¯á€›á€›á€¾á€­á€á€²á€·á€žá€°á€™á€¾á€¬ á€™á€Šá€ºá€žá€°á€”á€Šá€ºá€¸á‹",
    options: ["á€¦á€¸á€€á€»á€±á€¬á€ºá€…á€­á€¯á€¸", "á€¦á€¸á€…á€­á€¯á€¸á€á€„á€ºá€¸", "á€¦á€¸á€¡á€±á€¬á€„á€ºá€€á€¼á€®á€¸", "á€¦á€¸á€žá€­á€”á€ºá€¸á€‘á€½á€”á€ºá€¸"],
    correct: 0
  },
  {
    question: "á€™á€¼á€”á€ºá€™á€¬á€”á€­á€¯á€„á€ºá€„á€¶á á€¡á€™á€»á€­á€¯á€¸á€žá€¬á€¸á€¡á€¬á€¸á€€á€…á€¬á€¸á€”á€±á€·á€™á€¾á€¬ á€™á€Šá€ºá€žá€Šá€·á€ºá€”á€±á€·á€–á€¼á€…á€ºá€žá€”á€Šá€ºá€¸á‹",
    options: ["á€’á€®á€‡á€„á€ºá€˜á€¬ á", "á€”á€­á€¯á€á€„á€ºá€˜á€¬ ááˆ", "á€’á€®á€‡á€„á€ºá€˜á€¬ áá‰", "á€”á€­á€¯á€á€„á€ºá€˜á€¬ á‚á‡"],
    correct: 2
  },
  {
    question: "á€¡á€±á€¬á€€á€ºá€•á€«á€¡á€¬á€¸á€€á€…á€¬á€¸á€”á€Šá€ºá€¸á€™á€»á€¬á€¸á€¡á€”á€€á€º á€¡á€­á€¯á€œá€¶á€•á€…á€ºá€á€½á€„á€º á€•á€«á€á€„á€ºá€žá€±á€¬á€”á€Šá€ºá€¸á€™á€¾á€¬ á€™á€Šá€ºá€žá€Šá€ºá€”á€Šá€ºá€¸á‹",
    options: ["á€€á€¼á€€á€ºá€á€±á€¬á€€á€ºá€€á€½á€€á€º", "á€•á€­á€¯á€€á€ºá€€á€»á€±á€¬á€ºá€á€¼á€„á€ºá€¸", "á€™á€¼á€”á€ºá€™á€¬á€·á€‚á€»á€°á€’á€­á€¯", "á€á€­á€¯á€€á€ºá€€á€½á€™á€ºá€’á€­á€¯"],
    correct: 3
  },
  {
    question: "á€™á€¼á€”á€ºá€™á€¬á€”á€­á€¯á€„á€ºá€„á€¶á á€¡á€™á€»á€­á€¯á€¸á€žá€¬á€¸á€˜á€±á€¬á€œá€¯á€¶á€¸á€¡á€žá€„á€ºá€¸á€€á€­á€¯ á€™á€Šá€ºá€žá€Šá€·á€ºá€¡á€™á€Šá€ºá€–á€¼á€„á€·á€ºá€á€±á€«á€ºá€žá€”á€Šá€ºá€¸á‹",
    options: ["á€á€¼á€„á€ºá€¹á€žá€±á€·á€„á€šá€º", "á€á€¼á€„á€ºá€¹á€žá€±á€·á€™á€»á€¬á€¸", "á€€á€»á€¬á€¸á€™á€»á€¬á€¸", "á€€á€¼á€€á€ºá€–á€™á€»á€¬á€¸"],
    correct: 0
  },
  // ... á€’á€®á€”á€±á€›á€¬á€™á€¾á€¬ á€™á€±á€¸á€á€½á€”á€ºá€¸  á€‘á€•á€ºá€–á€¼á€Šá€·á€ºá€•á€« ...
];

// User state á€™á€»á€¬á€¸ á€žá€­á€™á€ºá€¸á€†á€Šá€ºá€¸á€›á€”á€º
const userState = new Map();

// UI á€¡á€á€½á€€á€º helper functions
function createProgressBar(current, total, width = 10) {
  const progress = Math.round((current / total) * width);
  return `[${'â–“'.repeat(progress)}${'â–‘'.repeat(width - progress)}]`;
}

function getRandomEmoji() {
  const emojis = ["âœ¨", "ðŸŒŸ", "ðŸ’«", "ðŸ”¥", "ðŸš€", "ðŸŽ¯", "ðŸ§ ", "ðŸ’¡"];
  return emojis[Math.floor(Math.random() * emojis.length)];
}

bot.start((ctx) => {
  const userId = ctx.from.id;
  userState.set(userId, {
    currentQuestion: 0,
    score: 0
  });
  
  ctx.replyWithMarkdown(
    `ðŸŒŸ *á€™á€¼á€”á€ºá€™á€¬á€•á€Šá€¬á€›á€±á€¸áŠ á€€á€»á€”á€ºá€¸á€™á€¬á€›á€±á€¸áŠ á€…á€®á€¸á€•á€½á€¬á€¸á€›á€±á€¸á€”á€¾á€„á€·á€º á€¡á€¬á€¸á€€á€…á€¬á€¸ Quiz Bot á€™á€¾ á€€á€¼á€­á€¯á€†á€­á€¯á€•á€«á€á€šá€º* ðŸŒŸ\n\n` +
    `á€¤á€˜á€±á€¬á€·á€žá€Šá€º á€™á€¼á€”á€ºá€™á€¬á€·á€—á€Ÿá€¯á€žá€¯á€á€™á€»á€¬á€¸á€€á€­á€¯ á€…á€™á€ºá€¸á€žá€•á€ºá€•á€±á€¸á€™á€Šá€·á€º á€¡á€‘á€°á€¸á€•á€¼á€¯á€œá€¯á€•á€ºá€‘á€¬á€¸á€žá€±á€¬ Quiz á€˜á€±á€¬á€·á€–á€¼á€…á€ºá€•á€«á€žá€Šá€ºá‹\n\n` +
    `á€¡á€±á€¬á€€á€ºá€•á€« command á€™á€»á€¬á€¸á€€á€­á€¯ á€žá€¯á€¶á€¸á€•á€«:\n` +
    `ðŸš€ /quiz - Quiz á€…á€á€„á€ºá€›á€”á€º\n` +
    `ðŸ“Š /score - á€›á€™á€¾á€á€ºá€€á€¼á€Šá€·á€ºá€›á€”á€º\n` +
    `â„¹ï¸ /help - á€¡á€€á€°á€¡á€Šá€®`,
    {
      reply_markup: {
        inline_keyboard: [
          [{ text: "ðŸš€ á€‚á€­á€™á€ºá€¸á€…á€á€„á€ºá€™á€šá€º", callback_data: "start_quiz" }],
          [{ text: "ðŸ“Š á€›á€™á€¾á€á€ºá€€á€¼á€Šá€·á€ºá€™á€šá€º", callback_data: "show_score" }]
        ]
      }
    }
  );
});

bot.action('start_quiz', (ctx) => {
  const userId = ctx.from.id;
  const state = userState.get(userId) || { currentQuestion: 0, score: 0 };
  state.currentQuestion = 0;
  state.score = 0;
  userState.set(userId, state);
  
  ctx.replyWithMarkdown(
    `ðŸŽ® *á€‚á€­á€™á€ºá€¸á€…á€á€„á€ºá€•á€«á€•á€¼á€®!* ${getRandomEmoji()}\n\n` +
    `á€™á€±á€¸á€á€½á€”á€ºá€¸ ${quizQuestions.length} á€á€¯ á€–á€¼á€±á€†á€­á€¯á€›á€™á€Šá€ºá‹\n` +
    `á€¡á€±á€¬á€€á€ºá€•á€«á€á€œá€¯á€á€ºá€€á€­á€¯á€”á€¾á€­á€•á€ºá€•á€¼á€®á€¸ á€…á€á€„á€ºá€”á€­á€¯á€„á€ºá€•á€«á€á€šá€º!`,
    {
      reply_markup: {
        inline_keyboard: [
          [{ text: "âœ… á€…á€á€„á€ºá€™á€šá€º", callback_data: "next_question" }]
        ]
      }
    }
  );
});

bot.action('next_question', (ctx) => {
  const userId = ctx.from.id;
  sendQuestion(ctx, userId);
});

function sendQuestion(ctx, userId) {
  const state = userState.get(userId);
  if (state.currentQuestion >= quizQuestions.length) {
    showResults(ctx, userId);
    return;
  }
  
  const question = quizQuestions[state.currentQuestion];
  const progressBar = createProgressBar(state.currentQuestion, quizQuestions.length);
  
  const keyboard = {
    inline_keyboard: [
      ...question.options.map((option, index) => [
        { 
          text: `${['A', 'B', 'C', 'D'][index]}. ${option}`, 
          callback_data: `ans_${index}`
        }
      ]),
      [{ text: "â© á€€á€»á€±á€¬á€ºá€™á€šá€º", callback_data: "skip_question" }]
    ]
  };
  
  ctx.replyWithMarkdown(
    `ðŸ“ *á€™á€±á€¸á€á€½á€”á€ºá€¸ ${state.currentQuestion + 1}/${quizQuestions.length}*\n\n` +
    `${progressBar}\n\n` +
    `â“ ${question.question}`,
    { reply_markup: keyboard }
  );
}

bot.action('skip_question', (ctx) => {
  const userId = ctx.from.id;
  const state = userState.get(userId);
  state.currentQuestion++;
  userState.set(userId, state);
  
  ctx.replyWithMarkdown(
    `â­ï¸ *á€™á€±á€¸á€á€½á€”á€ºá€¸á€€á€­á€¯ á€€á€»á€±á€¬á€ºá€œá€­á€¯á€€á€ºá€•á€«á€•á€¼á€®!*\n\n` +
    `á€”á€±á€¬á€€á€ºá€™á€±á€¸á€á€½á€”á€ºá€¸á€†á€®á€žá€­á€¯á€· á€†á€€á€ºá€žá€½á€¬á€¸á€•á€«á€™á€Šá€º...`
  );
  
  setTimeout(() => sendQuestion(ctx, userId), 1500);
});

bot.action(/ans_(\d+)/, (ctx) => {
  const userId = ctx.from.id;
  const state = userState.get(userId);
  const selectedOption = parseInt(ctx.match[1]);
  const currentQuestion = quizQuestions[state.currentQuestion];
  
  let replyText = '';
  
  if (selectedOption === currentQuestion.correct) {
    state.score++;
    replyText = `ðŸŽ‰ *á€™á€¾á€”á€ºá€•á€«á€á€šá€º!* ${getRandomEmoji()}\n\n` +
                `á€žá€„á€ºá€›á€½á€±á€¸á€á€»á€šá€ºá€‘á€¬á€¸á€á€¬: ${currentQuestion.options[selectedOption]}\n` +
                `+1 á€™á€¾á€á€º á€›á€›á€¾á€­á€•á€«á€•á€¼á€®!`;
  } else {
    replyText = `âŒ *á€™á€¾á€¬á€¸á€•á€«á€á€šá€º!*\n\n` +
                `á€žá€„á€ºá€›á€½á€±á€¸á€á€»á€šá€ºá€‘á€¬á€¸á€á€¬: ${currentQuestion.options[selectedOption]}\n` +
                `á€™á€¾á€”á€ºá€á€²á€·á€¡á€–á€¼á€±á€€: *${currentQuestion.options[currentQuestion.correct]}*`;
  }
  
  ctx.replyWithMarkdown(replyText);
  
  // á€”á€±á€¬á€€á€ºá€™á€±á€¸á€á€½á€”á€ºá€¸á€†á€®á€žá€­á€¯á€·
  state.currentQuestion++;
  userState.set(userId, state);
  
  setTimeout(() => {
    if (state.currentQuestion < quizQuestions.length) {
      sendQuestion(ctx, userId);
    } else {
      showResults(ctx, userId);
    }
  }, 2500);
});

function showResults(ctx, userId) {
  const state = userState.get(userId);
  const total = quizQuestions.length;
  const percentage = Math.round((state.score / total) * 100);
  
  let resultEmoji = "";
  if (percentage >= 80) resultEmoji = "ðŸ†";
  else if (percentage >= 60) resultEmoji = "ðŸŽ¯";
  else if (percentage >= 40) resultEmoji = "ðŸ™‚";
  else resultEmoji = "ðŸ˜¢";
  
  ctx.replyWithMarkdown(
    `ðŸ *á€‚á€­á€™á€ºá€¸á€•á€¼á€®á€¸á€†á€¯á€¶á€¸á€•á€«á€•á€¼á€®!* ${resultEmoji}\n\n` +
    `âœ… á€™á€¾á€”á€ºá€žá€±á€¬á€¡á€–á€¼á€±á€™á€»á€¬á€¸: ${state.score}/${total}\n` +
    `ðŸ“Š á€›á€¬á€á€­á€¯á€„á€ºá€”á€¾á€¯á€”á€ºá€¸: ${percentage}%\n\n` +
    `á€‘á€•á€ºá€™á€¶á€€á€…á€¬á€¸á€œá€­á€¯á€•á€«á€€ /start á€€á€­á€¯á€”á€¾á€­á€•á€ºá€•á€«á‹`,
    {
      reply_markup: {
        inline_keyboard: [
          [{ text: "ðŸ”„ á€•á€¼á€”á€ºá€…á€™á€šá€º", callback_data: "start_quiz" }],
          [{ text: "ðŸ“Š á€›á€™á€¾á€á€ºá€€á€¼á€Šá€·á€ºá€™á€šá€º", callback_data: "show_score" }]
        ]
      }
    }
  );
}

bot.action('show_score', (ctx) => {
  const userId = ctx.from.id;
  const state = userState.get(userId);
  
  if (state && state.currentQuestion > 0) {
    const total = quizQuestions.length;
    const percentage = Math.round((state.score / total) * 100);
    
    ctx.replyWithMarkdown(
      `ðŸ“Š *á€œá€€á€ºá€›á€¾á€­á€›á€™á€¾á€á€ºá€™á€»á€¬á€¸*\n\n` +
      `âœ… á€™á€¾á€”á€ºá€žá€±á€¬á€¡á€–á€¼á€±á€™á€»á€¬á€¸: *${state.score}/${total}*\n` +
      `ðŸ“ˆ á€›á€¬á€á€­á€¯á€„á€ºá€”á€¾á€¯á€”á€ºá€¸: *${percentage}%*`
    );
  } else {
    ctx.replyWithMarkdown(
      `â„¹ï¸ á€žá€„á€ºá€‚á€­á€™á€ºá€¸á€™á€…á€žá€±á€¸á€•á€«á‹\n` +
      `á€‚á€­á€™á€ºá€¸á€…á€á€„á€ºá€›á€”á€º /start á€€á€­á€¯á€”á€¾á€­á€•á€ºá€•á€«á‹`
    );
  }
});

bot.help((ctx) => {
  ctx.replyWithMarkdown(
    `â„¹ï¸ *á€¡á€€á€°á€¡á€Šá€®*\n\n` +
    `*Commands:*\n` +
    `/start - Bot á€…á€á€„á€ºá€›á€”á€º\n` +
    `/quiz - Quiz á€‚á€­á€™á€ºá€¸á€…á€á€„á€ºá€›á€”á€º\n` +
    `/score - á€œá€€á€ºá€›á€¾á€­á€›á€™á€¾á€á€ºá€€á€¼á€Šá€·á€ºá€›á€”á€¯\n` +
    `/help - á€¡á€€á€°á€¡á€Šá€®\n\n` +
    `*á€‚á€­á€™á€ºá€¸á€€á€…á€¬á€¸á€”á€Šá€ºá€¸:*\n` +
    `1. /quiz á€–á€¼á€„á€·á€ºá€‚á€­á€™á€ºá€¸á€…á€á€„á€ºá€•á€«\n` +
    `2. á€•á€±á€¸á€‘á€¬á€¸á€žá€±á€¬á€›á€½á€±á€¸á€á€»á€šá€ºá€…á€›á€¬á€™á€»á€¬á€¸á€™á€¾á€–á€¼á€±á€†á€­á€¯á€•á€«\n` +
    `3. á€›á€™á€¾á€á€ºá€™á€»á€¬á€¸á€€á€­á€¯á€€á€¼á€Šá€·á€ºá€›á€¾á€¯á€”á€­á€¯á€„á€ºá€•á€«á€á€šá€º`
  );
});

bot.command('quiz', (ctx) => {
  const userId = ctx.from.id;
  const state = userState.get(userId) || { currentQuestion: 0, score: 0 };
  state.currentQuestion = 0;
  state.score = 0;
  userState.set(userId, state);
  sendQuestion(ctx, userId);
});

bot.launch();
console.log('Bot is running...');

// Graceful shutdown
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));
